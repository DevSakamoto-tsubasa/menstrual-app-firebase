<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ - ç”Ÿç†æ—¥å…±æœ‰ã‚¢ãƒ—ãƒª</title>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9ff;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        .user-info {
            background: rgba(125, 211, 252, 0.1);
            padding: 8px 16px;
            font-size: 12px;
            text-align: center;
            color: #0284c7;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .header {
            background: white;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .header-subtitle {
            font-size: 14px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #7dd3fc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .content {
            padding: 20px 16px;
        }
        
        .status-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .partner-connected {
            border-left: 4px solid #10b981;
        }
        
        .partner-disconnected {
            border-left: 4px solid #f59e0b;
        }
        
        .invite-acceptance {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(135deg, #fef7ff, #f3e8ff);
        }
        
        .status-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }
        
        .status-connected {
            background: #10b981;
        }
        
        .status-disconnected {
            background: #f59e0b;
        }
        
        .status-invite {
            background: #8b5cf6;
        }
        
        .status-details h3 {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .status-details p {
            color: #6b7280;
            font-size: 12px;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }
        
        .action-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: #7dd3fc;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0284c7;
        }
        
        .btn-secondary {
            background: #f8fafc;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        
        .btn-secondary:hover {
            background: #e0f2fe;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-accept {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 16px;
            padding: 16px 24px;
            width: 100%;
            margin-bottom: 12px;
        }
        
        .btn-decline {
            background: #f3f4f6;
            color: #6b7280;
            border: 2px solid #e5e7eb;
            padding: 12px 24px;
            width: 100%;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
        }
        
        .invite-section {
            text-align: center;
            padding: 20px 0;
        }
        
        .invite-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        
        .invite-description {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.5;
            font-size: 14px;
        }
        
        .invite-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .invite-link-display {
            background: #f8fafc;
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            display: none;
        }
        
        .invite-link {
            background: #e5e7eb;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            margin: 12px 0;
            color: #374151;
        }
        
        .share-options {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }
        
        .feature-cards {
            margin-top: 16px;
        }
        
        .feature-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .feature-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #7dd3fc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .feature-content h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #374151;
        }
        
        .feature-content p {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
        }
        
        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 16px;
            border-radius: 12px;
            margin: 16px;
            text-align: center;
            font-size: 14px;
            border: 1px solid #fecaca;
        }
        
        .success-message {
            background: #f0fdf4;
            color: #166534;
            padding: 16px;
            border-radius: 12px;
            margin: 16px;
            text-align: center;
            font-size: 14px;
            border: 1px solid #bbf7d0;
        }
        
        .info-message {
            background: #fefbf3;
            color: #b45309;
            padding: 16px;
            border-radius: 12px;
            margin: 16px;
            text-align: center;
            font-size: 14px;
            border: 1px solid #fed7aa;
        }
        
        .invite-info {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #8b5cf6;
        }
        
        .invite-info h4 {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .invite-info p {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 4px;
        }
        
        .privacy-note {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 24px;
            line-height: 1.4;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .hidden { display: none; }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="userInfo" class="user-info" style="display: none;">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
        </div>
        
        <div class="header">
            <div class="header-title">ğŸ‘« ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</div>
            <div class="header-subtitle">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®é€£æºãƒ»ã‚µãƒãƒ¼ãƒˆ</div>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>

        <!-- ğŸ¯ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆå‹•çš„ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ï¼‰ -->
        <div id="content" class="content hidden">
            <!-- ã“ã“ã«å„ãƒ¢ãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
        </div>

        <div id="error" class="hidden">
            <div class="error-message">
                ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>
                å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
            </div>
        </div>
    </div>

    <script>
        let currentUserId = null;
        let partnerData = null;
        let generatedInviteLink = null;
        let currentInviteType = null;
        let appMode = null; // 'normal' or 'invite'
        let inviteId = null;
        
        const PARTNER_LIFF_ID = '2007500037-XROaPWoj'; // ğŸ”¥ çµ±åˆLIFF ID
        const API_BASE_URL = 'https://asia-northeast1-menstrual-tracking-app.cloudfunctions.net';

        // ğŸš€ ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–é–¢æ•°
        async function initializePartnerPage() {
            try {
                console.log('=== Partner Page Initialization ===');
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
                const urlParams = new URLSearchParams(window.location.search);
                const mode = urlParams.get('mode');
                inviteId = urlParams.get('inviteId');
                
                if (mode === 'invite' && inviteId) {
                    appMode = 'invite';
                    console.log('ğŸ¯ Invite acceptance mode detected:', inviteId);
                } else {
                    appMode = 'normal';
                    console.log('ğŸ¯ Normal partner management mode');
                }
                
                // LIFFåˆæœŸåŒ–
                await liff.init({ 
                    liffId: PARTNER_LIFF_ID,
                    withLoginOnExternalBrowser: true
                });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                
                console.log('User authenticated:', currentUserId);
                console.log('App mode:', appMode);
                
                // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦åˆæœŸåŒ–
                if (appMode === 'invite') {
                    await initializeInviteMode();
                } else {
                    await initializeNormalMode();
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ğŸ¯ æ‹›å¾…æ‰¿èªãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
        async function initializeInviteMode() {
            try {
                console.log('Loading invite info for ID:', inviteId);
                
                const response = await fetch(`${API_BASE_URL}/getPartnerInviteInfo?inviteId=${inviteId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    if (data.error === 'Invite expired or already used') {
                        showInviteExpired();
                    } else {
                        showError(data.error || 'æ‹›å¾…æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    return;
                }
                
                showInviteAcceptanceUI(data.inviteData);
                
            } catch (error) {
                console.error('Error in invite mode:', error);
                showError('æ‹›å¾…æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ğŸ‘« é€šå¸¸ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
        async function initializeNormalMode() {
            try {
                await loadPartnerData();
            } catch (error) {
                console.error('Error in normal mode:', error);
                showError('ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        // ğŸ“± æ‹›å¾…æ‰¿èªUIè¡¨ç¤º
        function showInviteAcceptanceUI(inviteData) {
            hideLoading();
            document.getElementById('content').classList.remove('hidden');
            
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="status-card invite-acceptance">
                    <div class="status-header">
                        <div class="status-icon status-invite">ğŸ’Œ</div>
                        <div class="status-details">
                            <h3>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ‹›å¾…</h3>
                            <p>ã‚ãªãŸã‚’æ‹›å¾…ã—ã¦ã„ã¾ã™</p>
                        </div>
                    </div>
                </div>
                
                <div class="invite-info">
                    <h4>ğŸ‘¤ æ‹›å¾…è€…æƒ…å ±</h4>
                    <p><strong>${inviteData.inviterName}</strong></p>
                    <p>æ‹›å¾…æ—¥: ${new Date(inviteData.createdAt).toLocaleDateString('ja-JP')}</p>
                    <p>æœ‰åŠ¹æœŸé™: ${new Date(inviteData.expiresAt).toLocaleDateString('ja-JP')} ${new Date(inviteData.expiresAt).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</p>
                </div>
                
                <div class="feature-cards">
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ©¸</div>
                        <div class="feature-content">
                            <h4>è‡ªå‹•é€šçŸ¥</h4>
                            <p>ç”Ÿç†é–‹å§‹æ™‚ã«ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«è‡ªå‹•ã§é€šçŸ¥ã•ã‚Œã¾ã™</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ’</div>
                        <div class="feature-content">
                            <h4>ã‚µãƒãƒ¼ãƒˆæƒ…å ±</h4>
                            <p>ãŠäº’ã„ã®å¥åº·çŠ¶æ…‹ã‚’å…±æœ‰ã—ã¦ã‚µãƒãƒ¼ãƒˆã—åˆãˆã¾ã™</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ“…</div>
                        <div class="feature-content">
                            <h4>äºˆæ¸¬å…±æœ‰</h4>
                            <p>æ¬¡å›ç”Ÿç†æ—¥ã‚„æ’åµæ—¥ã®äºˆæ¸¬ã‚’å…±æœ‰ã§ãã¾ã™</p>
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions" style="grid-template-columns: 1fr; gap: 12px; margin-top: 24px;">
                    <button class="action-btn btn-accept" onclick="acceptInvite()">
                        ğŸ’• æ‹›å¾…ã‚’æ‰¿èªã™ã‚‹
                    </button>
                    <button class="action-btn btn-decline" onclick="declineInvite()">
                        âŒ è¾é€€ã™ã‚‹
                    </button>
                </div>
                
                <div class="privacy-note">
                    ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·<br>
                    ç”Ÿç†æ—¥æƒ…å ±ã®ã¿ãŒå…±æœ‰ã•ã‚Œã€ãã®ä»–ã®å€‹äººæƒ…å ±ã¯ä¿è­·ã•ã‚Œã¾ã™ã€‚
                    ã„ã¤ã§ã‚‚é–¢ä¿‚ã‚’è§£é™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
                </div>
            `;
        }

        // ğŸ‘« ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰
        async function loadPartnerData() {
            try {
                const response = await fetch(`${API_BASE_URL}/getPartnerData`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId
                    })
                });
                
                const data = await response.json();
                
                hideLoading();
                document.getElementById('content').classList.remove('hidden');
                
                if (data.hasPartner) {
                    // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ¥ç¶šæ¸ˆã¿
                    showConnectedPartnerUI(data);
                } else {
                    // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æœªæ¥ç¶š
                    showDisconnectedPartnerUI();
                }
                
            } catch (error) {
                console.error('Error loading partner data:', error);
                showError('ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ğŸ“± æ¥ç¶šæ¸ˆã¿ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼UI
        function showConnectedPartnerUI(data) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="status-card partner-connected">
                    <div class="status-header">
                        <div class="status-icon status-connected">ğŸ‘«</div>
                        <div class="status-details">
                            <h3>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ¥ç¶šä¸­</h3>
                            <p>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼: ${data.partnerId}</p>
                            <p>æ¥ç¶šæ—¥: ${data.connectionDate}</p>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="action-btn btn-primary" onclick="openSupportSettings()">
                            ğŸ’ ã‚µãƒãƒ¼ãƒˆè¨­å®š
                        </button>
                        <button class="action-btn btn-secondary" onclick="viewPartnerInfo()">
                            ğŸ“Š ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±
                        </button>
                        <button class="action-btn btn-secondary" onclick="testNotification()">
                            ğŸ”” é€šçŸ¥ãƒ†ã‚¹ãƒˆ
                        </button>
                        <button class="action-btn btn-danger" onclick="disconnectPartner()">
                            ğŸ”— æ¥ç¶šè§£é™¤
                        </button>
                    </div>
                </div>
                
                <div class="feature-cards">
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ©¸</div>
                        <div class="feature-content">
                            <h4>è‡ªå‹•é€šçŸ¥</h4>
                            <p>ç”Ÿç†é–‹å§‹æ™‚ã«ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«è‡ªå‹•ã§é€šçŸ¥ã•ã‚Œã¾ã™</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ’</div>
                        <div class="feature-content">
                            <h4>ã‚µãƒãƒ¼ãƒˆæƒ…å ±</h4>
                            <p>ç”Ÿç†ä¸­ã«ã—ã¦æ¬²ã—ã„ã“ã¨ã‚„é£Ÿã¹ãŸã„ã‚‚ã®ã‚’å…±æœ‰</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ“…</div>
                        <div class="feature-content">
                            <h4>äºˆæ¸¬å…±æœ‰</h4>
                            <p>æ¬¡å›ç”Ÿç†æ—¥ã‚„æ’åµæ—¥ã®äºˆæ¸¬ã‚’å…±æœ‰</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ğŸ“± æœªæ¥ç¶šãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼UI
        function showDisconnectedPartnerUI() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="status-card partner-disconnected">
                    <div class="status-header">
                        <div class="status-icon status-disconnected">ğŸ‘¤</div>
                        <div class="status-details">
                            <h3>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æœªæ¥ç¶š</h3>
                            <p>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’æ‹›å¾…ã—ã¦ä¸€ç·’ã«å¥åº·ç®¡ç†ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</p>
                        </div>
                    </div>
                </div>
                
                <div class="invite-section">
                    <div class="invite-title">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’æ‹›å¾…</div>
                    <div class="invite-description">
                        ç°¡å˜ã«ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’æ‹›å¾…ã§ãã¾ã™ã€‚<br>
                        æ‰¿èªç”¨ãƒªãƒ³ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã ã‘ã§æ¥ç¶šå®Œäº†ï¼
                    </div>
                    
                    <div class="invite-options">
                        <button class="action-btn btn-primary" onclick="generateLiffInvite()" style="width: 100%;">
                            ğŸŒŸ æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
                        </button>
                    </div>
                    
                    <div id="inviteLinkDisplay" class="invite-link-display">
                        <p id="inviteTypeLabel"><strong>æ‹›å¾…ãƒªãƒ³ã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼</strong></p>
                        <div id="inviteLink" class="invite-link">
                            ç”Ÿæˆä¸­...
                        </div>
                        <div class="share-options">
                            <button class="action-btn btn-primary" onclick="shareViaLine()">
                                ğŸ“± LINEã§é€ä¿¡
                            </button>
                            <button class="action-btn btn-secondary" onclick="copyLink()">
                                ğŸ“‹ ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            â° ãƒªãƒ³ã‚¯ã¯24æ™‚é–“æœ‰åŠ¹ã§ã™
                        </p>
                    </div>
                </div>
                
                <div class="feature-cards">
                    <div class="feature-card">
                        <div class="feature-icon">â¤ï¸</div>
                        <div class="feature-content">
                            <h4>ãŠäº’ã„ã‚’æ€ã„ã‚„ã‚‹</h4>
                            <p>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ä½“èª¿ã‚’å…±æœ‰ã—ã¦ã€ã‚µãƒãƒ¼ãƒˆã—åˆãˆã¾ã™</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ”’</div>
                        <div class="feature-content">
                            <h4>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·</h4>
                            <p>ç”Ÿç†æ—¥æƒ…å ±ã®ã¿ãŒå…±æœ‰ã•ã‚Œã€ä»–ã®æƒ…å ±ã¯ä¿è­·ã•ã‚Œã¾ã™</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ“Š</div>
                        <div class="feature-content">
                            <h4>å¥åº·ç®¡ç†</h4>
                            <p>äºŒäººã§ä¸€ç·’ã«å¥åº·ã‚’ç®¡ç†ã—ã€ç†è§£ã‚’æ·±ã‚ã‚‰ã‚Œã¾ã™</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ğŸ”¥ LIFFæ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆ
        async function generateLiffInvite() {
            try {
                console.log('Generating LIFF invite...');
                
                const response = await fetch(`${API_BASE_URL}/generatePartnerInvite`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'LIFFæ‹›å¾…ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                generatedInviteLink = data.inviteUrl;
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                document.getElementById('inviteTypeLabel').innerHTML = 
                    '<strong>ğŸŒŸ æ‹›å¾…ãƒªãƒ³ã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼</strong>';
                document.getElementById('inviteLink').textContent = data.inviteUrl;
                document.getElementById('inviteLinkDisplay').style.display = 'block';
                
                console.log('LIFF invite generated:', data.inviteUrl);
                
            } catch (error) {
                console.error('Error generating LIFF invite:', error);
                showMessage('æ‹›å¾…ãƒªãƒ³ã‚¯ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // ğŸ“± LINEã§å…±æœ‰
        async function shareViaLine() {
            try {
                if (!generatedInviteLink) {
                    showMessage('æ‹›å¾…ãƒªãƒ³ã‚¯ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }
                
                const shareText = `ğŸŒ¸ ç”Ÿç†æ—¥å…±æœ‰ã‚¢ãƒ—ãƒªã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ‹›å¾…\n\nğŸ’• ä¸€ç·’ã«å¥åº·ç®¡ç†ã‚’ã—ã¾ã›ã‚“ã‹ï¼Ÿ\nä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ‰¿èªã—ã¦ãã ã•ã„ï¼\n\n${generatedInviteLink}\n\nâ° æœ‰åŠ¹æœŸé™: 24æ™‚é–“`;
                
                if (liff.isInClient()) {
                    // LINEå†…ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯å…±æœ‰APIä½¿ç”¨
                    await liff.shareTargetPicker([{
                        type: 'text',
                        text: shareText
                    }]);
                } else {
                    // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                    await navigator.clipboard.writeText(shareText);
                    showMessage('æ‹›å¾…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nLINEã«è²¼ã‚Šä»˜ã‘ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚', 'success');
                }
                
            } catch (error) {
                console.error('Error sharing via LINE:', error);
                showMessage('å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ğŸ“‹ ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
        async function copyLink() {
            try {
                if (!generatedInviteLink) {
                    showMessage('æ‹›å¾…ãƒªãƒ³ã‚¯ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }
                
                await navigator.clipboard.writeText(generatedInviteLink);
                showMessage('æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
                
            } catch (error) {
                console.error('Error copying link:', error);
                showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ğŸ’• æ‹›å¾…æ‰¿èª
        async function acceptInvite() {
            try {
                const acceptBtn = document.querySelector('.btn-accept');
                acceptBtn.textContent = 'æ‰¿èªä¸­...';
                acceptBtn.disabled = true;
                
                const response = await fetch(`${API_BASE_URL}/acceptPartnerInvite`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inviteId: inviteId,
                        userId: currentUserId
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                console.log('Partner invite accepted successfully');
                
                // æˆåŠŸç”»é¢ã‚’è¡¨ç¤º
                showInviteSuccessUI();
                
            } catch (error) {
                console.error('Error accepting invite:', error);
                showMessage(error.message, 'error');
                
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                const acceptBtn = document.querySelector('.btn-accept');
                acceptBtn.textContent = 'ğŸ’• æ‹›å¾…ã‚’æ‰¿èªã™ã‚‹';
                acceptBtn.disabled = false;
            }
        }

        // âŒ æ‹›å¾…è¾é€€
        function declineInvite() {
            if (confirm('æœ¬å½“ã«æ‹›å¾…ã‚’è¾é€€ã—ã¾ã™ã‹ï¼Ÿ')) {
                // LIFFã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã‚‹
                if (liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.close();
                }
            }
        }

        // ğŸ‰ æ‹›å¾…æ‰¿èªæˆåŠŸUI
        function showInviteSuccessUI() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="status-card partner-connected">
                    <div class="status-header">
                        <div class="status-icon status-connected pulse">ğŸ’•</div>
                        <div class="status-details">
                            <h3>æ‰¿èªå®Œäº†ï¼</h3>
                            <p>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—ãŒæˆç«‹ã—ã¾ã—ãŸ</p>
                        </div>
                    </div>
                </div>
                
                <div class="success-message">
                    ğŸ‰ æ‹›å¾…ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸï¼<br>
                    ã“ã‚Œã‹ã‚‰ãŠäº’ã„ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã—ã‚‡ã†
                </div>
                
                <div class="feature-cards">
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ©¸</div>
                        <div class="feature-content">
                            <h4>è‡ªå‹•é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ</h4>
                            <p>ç”Ÿç†é–‹å§‹æ™‚ã«ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«è‡ªå‹•ã§é€šçŸ¥ã•ã‚Œã¾ã™</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ’</div>
                        <div class="feature-content">
                            <h4>å¥åº·æƒ…å ±ã®å…±æœ‰</h4>
                            <p>ãŠäº’ã„ã®å¥åº·çŠ¶æ…‹ã‚’ã‚µãƒãƒ¼ãƒˆã—åˆãˆã¾ã™</p>
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions" style="grid-template-columns: 1fr; gap: 12px; margin-top: 24px;">
                    <button class="action-btn btn-primary" onclick="openMainApp()">
                        ğŸ“± ã‚¢ãƒ—ãƒªã®ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸
                    </button>
                </div>
            `;
        }

        // ğŸ“± æœŸé™åˆ‡ã‚ŒUI
        function showInviteExpired() {
            hideLoading();
            document.getElementById('content').classList.remove('hidden');
            
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="info-message">
                    â° ã“ã®æ‹›å¾…ã¯æœŸé™åˆ‡ã‚Œã§ã™<br>
                    æ–°ã—ã„æ‹›å¾…ã‚’é€ã£ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„
                </div>
                
                <div class="quick-actions" style="grid-template-columns: 1fr; margin-top: 24px;">
                    <button class="action-btn btn-secondary" onclick="closeApp()">
                        âŒ é–‰ã˜ã‚‹
                    </button>
                </div>
            `;
        }

        // ğŸ“± ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’é–‹ã
        function openMainApp() {
            // ãƒ¡ã‚¤ãƒ³LIFFã‚¢ãƒ—ãƒªã«é·ç§»
            const MAIN_LIFF_ID = '2007500037-w97Oo2kv'; // ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            const appUrl = `https://liff.line.me/${MAIN_LIFF_ID}`;
            
            if (liff.isInClient()) {
                // LINEå†…ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
                liff.sendMessages([{
                    type: 'text',
                    text: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰'
                }]).then(() => {
                    liff.closeWindow();
                });
            } else {
                // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯ç›´æ¥é·ç§»
                window.location.href = appUrl;
            }
        }

        // âŒ ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã‚‹
        function closeApp() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }

        // ãã®ä»–ã®æ©Ÿèƒ½ï¼ˆã‚¹ã‚¿ãƒ–å®Ÿè£…ï¼‰
        function openSupportSettings() {
            showMessage('ã‚µãƒãƒ¼ãƒˆè¨­å®šæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™', 'info');
        }

        function viewPartnerInfo() {
            showMessage('ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±è¡¨ç¤ºæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™', 'info');
        }

        function testNotification() {
            showMessage('é€šçŸ¥ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™', 'info');
        }

        function disconnectPartner() {
            if (confirm('æœ¬å½“ã«ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ¥ç¶šã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                showMessage('ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è§£é™¤æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™', 'info');
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message) {
            hideLoading();
            document.getElementById('error').classList.remove('hidden');
            document.querySelector('#error .error-message').innerHTML = message;
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            messageDiv.innerHTML = message;
            
            const content = document.getElementById('content');
            content.insertBefore(messageDiv, content.firstChild);
            
            // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', initializePartnerPage);
    </script>
</body>
</html>>