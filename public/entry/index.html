<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿç†é–‹å§‹æ—¥å…¥åŠ› | ç”Ÿç†æ—¥å…±æœ‰ã‚¢ãƒ—ãƒª</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa8a8);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.2);
            margin: 15px -20px 0;
            padding: 10px 20px;
            font-size: 14px;
            text-align: center;
            border-radius: 10px;
        }

        .form-section {
            padding: 30px 20px;
        }

        .info-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .info-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .info-card-text {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .date-picker-card {
            background: white;
            border: 2px solid #e1e5f2;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .date-picker-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .date-picker-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .date-input-group {
            margin-bottom: 15px;
        }

        .date-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5f2;
            border-radius: 10px;
            font-size: 16px;
            background: #f8f9ff;
            color: #333;
        }

        .date-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .quick-date-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .quick-date-btn {
            padding: 12px;
            border: 2px solid #e1e5f2;
            border-radius: 10px;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-date-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .quick-date-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .period-duration-card {
            background: white;
            border: 2px solid #e1e5f2;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .duration-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .duration-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .duration-btn {
            padding: 12px 8px;
            border: 2px solid #e1e5f2;
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .duration-btn:hover {
            border-color: #ff6b6b;
            background: #ffeaea;
        }

        .duration-btn.active {
            border-color: #ff6b6b;
            background: #ff6b6b;
            color: white;
        }

        .error-message {
            background: #ffe6e6;
            border: 2px solid #ff9999;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #d63384;
            font-size: 14px;
            display: none;
        }

        .btn-primary {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            min-height: 300px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: #666;
            font-size: 16px;
            text-align: center;
        }

        .success-message {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            min-height: 300px;
        }

        .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .success-message h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .success-message p {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .update-info {
            background: #f0f7ff;
            border: 2px solid #b3d9ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .update-icon {
            font-size: 20px;
        }

        .update-info p {
            margin: 0;
            font-size: 14px;
            color: #0066cc;
        }

        .update-complete {
            background: #f0fff4;
            border-color: #90ee90;
        }

        .update-complete p {
            color: #228b22;
        }

        .debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            display: none;
            max-width: 300px;
            word-wrap: break-word;
        }

        .timezone-debug {
            background: #e8f4f8;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            color: #0066cc;
            display: none;
        }

        @media (max-width: 480px) {
            .duration-options {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .quick-date-options {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¸ ç”Ÿç†é–‹å§‹æ—¥å…¥åŠ›</h1>
            <p>æ­£ç¢ºãªè¨˜éŒ²ã§ç²¾åº¦ã®é«˜ã„äºˆæ¸¬ã‚’</p>
            <div id="userInfo" class="user-info" style="display: none;">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
            </div>
        </div>
        
        <div id="entryForm" class="form-section">
            <div class="info-card">
                <div class="info-card-title">ğŸ“ è¨˜éŒ²ã«ã¤ã„ã¦</div>
                <div class="info-card-text">ç”Ÿç†é–‹å§‹æ—¥ã‚’æ­£ç¢ºã«è¨˜éŒ²ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„äºˆæ¸¬ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</div>
            </div>
            
            <div class="date-picker-card">
                <div class="date-picker-title">ğŸ—“ï¸ ç”Ÿç†é–‹å§‹æ—¥</div>
                <div class="date-picker-description">ã„ã¤ã‹ã‚‰ç”Ÿç†ãŒå§‹ã¾ã‚Šã¾ã—ãŸã‹ï¼Ÿ</div>
                
                <div class="date-input-group">
                    <input type="date" id="startDateInput" class="date-input">
                </div>
                
                <div class="quick-date-options">
                    <button class="quick-date-btn" onclick="setQuickDate(0)">ä»Šæ—¥</button>
                    <button class="quick-date-btn" onclick="setQuickDate(1)">æ˜¨æ—¥</button>
                    <button class="quick-date-btn" onclick="setQuickDate(2)">ä¸€æ˜¨æ—¥</button>
                    <button class="quick-date-btn" onclick="setQuickDate(3)">3æ—¥å‰</button>
                </div>
            </div>
            
            <div class="period-duration-card">
                <div class="duration-title">â±ï¸ ç”Ÿç†æœŸé–“ï¼ˆäºˆæƒ³ï¼‰</div>
                <div class="duration-options">
                    <button class="duration-btn" onclick="setDuration(3)">3æ—¥</button>
                    <button class="duration-btn" onclick="setDuration(4)">4æ—¥</button>
                    <button class="duration-btn active" onclick="setDuration(5)">5æ—¥</button>
                    <button class="duration-btn" onclick="setDuration(6)">6æ—¥</button>
                    <button class="duration-btn" onclick="setDuration(7)">7æ—¥</button>
                    <button class="duration-btn" onclick="setDuration(8)">8æ—¥</button>
                    <button class="duration-btn" onclick="setDuration(9)">9æ—¥</button>
                    <button class="duration-btn" onclick="setDuration(10)">10æ—¥</button>
                </div>
            </div>
            
            <div class="timezone-debug" id="timezoneDebug">
                <!-- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
            </div>
            
            <div class="error-message" id="errorMessage">
                <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            </div>
            
            <button type="button" class="btn-primary" onclick="savePeriodStart()">
                è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹
            </button>
        </div>
        
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>è¨˜éŒ²ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™...</p>
        </div>
        
        <div id="success" class="success-message">
            <div class="success-icon">âœ…</div>
            <h2>è¨˜éŒ²å®Œäº†ï¼</h2>
            <p>ç”Ÿç†é–‹å§‹æ—¥ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸ</p>
        </div>
    </div>

    <div id="debugPanel" class="debug-panel">
        Debug: Ready
    </div>

    <script>
        // ğŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œç‰ˆ: æ—¥ä»˜å‡¦ç†é–¢æ•°é›†
        const TimezoneFixes = {
            /**
             * æ—¥ä»˜æ–‡å­—åˆ—ã‚’æ—¥æœ¬æ™‚é–“ã® Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å®‰å…¨ã«å¤‰æ›
             */
            parseJapanDate: function(dateString) {
                if (!dateString) return null;
                
                console.log(`ğŸŒ Parsing date: ${dateString}`);
                
                // YYYY-MM-DD å½¢å¼ã®å ´åˆã€æ—¥æœ¬æ™‚é–“ã¨ã—ã¦è§£é‡ˆ
                const [year, month, day] = dateString.split('-').map(num => parseInt(num, 10));
                
                // æ—¥æœ¬æ™‚é–“ã§æ­£ç¢ºã«ä½œæˆï¼ˆæœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰
                const japanDate = new Date(year, month - 1, day, 0, 0, 0, 0);
                
                console.log(`âœ… Parsed to Japan date: ${japanDate.toLocaleDateString('ja-JP')}`);
                return japanDate;
            },

            /**
             * Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ—¥æœ¬æ™‚é–“ã® YYYY-MM-DD å½¢å¼ã«å¤‰æ›
             */
            formatJapanDate: function(date) {
                if (!date || isNaN(date.getTime())) {
                    return 'æ—¥ä»˜ä¸æ˜';
                }
                
                // æ—¥æœ¬æ™‚é–“ã§å¹´æœˆæ—¥ã‚’å–å¾—
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                const formatted = `${year}-${month}-${day}`;
                console.log(`ğŸ“… Formatted Japan date: ${formatted}`);
                return formatted;
            },

            /**
             * ä»Šæ—¥ã®æ—¥ä»˜ã‚’æ—¥æœ¬æ™‚é–“ã§å–å¾—
             */
            getTodayJapan: function() {
                const now = new Date();
                
                // æ—¥æœ¬æ™‚é–“ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä½œæˆï¼ˆæ™‚é–“ã¯00:00:00ï¼‰
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
                
                console.log(`ğŸ“… Today Japan: ${today.toLocaleDateString('ja-JP')}`);
                return today;
            },

            /**
             * æ—¥ä»˜ã«æ—¥æ•°ã‚’åŠ ç®—ï¼ˆæ—¥æœ¬æ™‚é–“ãƒ™ãƒ¼ã‚¹ï¼‰
             */
            addDaysJapan: function(date, days) {
                if (!date || isNaN(date.getTime())) return null;
                
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                
                console.log(`ğŸ“… Added ${days} days to ${this.formatJapanDate(date)} = ${this.formatJapanDate(result)}`);
                return result;
            },

            /**
             * æ—¥ä»˜æ¯”è¼ƒï¼ˆæ—¥æœ¬æ™‚é–“ãƒ™ãƒ¼ã‚¹ï¼‰
             */
            compareDatesJapan: function(date1, date2) {
                if (!date1 || !date2) return 0;
                
                // æ—¥ä»˜ã®ã¿ã§æ¯”è¼ƒï¼ˆæ™‚é–“ã¯ç„¡è¦–ï¼‰
                const d1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
                const d2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
                
                if (d1 < d2) return -1;
                if (d1 > d2) return 1;
                return 0;
            },

            /**
             * ãƒ‡ãƒãƒƒã‚°ç”¨: æ—¥ä»˜æƒ…å ±ã‚’è©³ç´°è¡¨ç¤º
             */
            debugDateInfo: function(date, label = 'Date') {
                if (!date) {
                    console.log('ğŸ”— Calendar page prefetched');
                }
                
            } catch (error) {
                console.error('âŒ Calendar update notification error:', error);
                throw error;
            }
        }

        // ğŸš€ æˆåŠŸè¡¨ç¤ºã®æ”¹å–„
        function showSuccessWithCalendarUpdate() {
            const successDiv = document.getElementById('success');
            const loadingDiv = document.getElementById('loading');
            
            // æˆåŠŸè¡¨ç¤ºã‚’æ›´æ–°
            successDiv.innerHTML = `
                <div class="success-icon">âœ…</div>
                <h2>è¨˜éŒ²å®Œäº†ï¼</h2>
                <p>ç”Ÿç†é–‹å§‹æ—¥ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸ</p>
                <div class="update-info">
                    <div class="update-icon">ğŸ”„</div>
                    <p>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...</p>
                </div>
            `;
            
            loadingDiv.style.display = 'none';
            successDiv.style.display = 'flex';
            
            // 2ç§’å¾Œã«æ›´æ–°å®Œäº†è¡¨ç¤º
            setTimeout(() => {
                const updateInfo = successDiv.querySelector('.update-info');
                if (updateInfo) {
                    updateInfo.className = 'update-info update-complete';
                    updateInfo.innerHTML = `
                        <div class="update-icon">âœ…</div>
                        <p>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ</p>
                    `;
                }
            }, 2000);
        }

        // ğŸš€ ä»–ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
        window.addEventListener('storage', function(e) {
            if (e.key === 'calendar_update_event') {
                console.log('ğŸ“¢ Calendar update event received from storage');
                updateDebug('Storage event received');
                
                try {
                    const eventData = JSON.parse(e.newValue);
                    if (eventData && eventData.type === 'period_record_saved') {
                        console.log('ğŸ”„ Processing calendar update event...');
                        
                        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°å‡¦ç†ãŒã‚ã‚Œã°å®Ÿè¡Œ
                        if (typeof window.updateCalendarAfterSave === 'function') {
                            window.updateCalendarAfterSave();
                        }
                    }
                } catch (error) {
                    console.error('âŒ Error processing calendar update event:', error);
                }
            }
        });

        // ğŸš€ PostMessage ãƒªã‚¹ãƒŠãƒ¼
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'period_record_saved') {
                console.log('ğŸ“¢ Calendar update event received from PostMessage');
                updateDebug('PostMessage received');
                
                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°å‡¦ç†ãŒã‚ã‚Œã°å®Ÿè¡Œ
                if (typeof window.updateCalendarAfterSave === 'function') {
                    window.updateCalendarAfterSave();
                }
            }
        });

        // ğŸš€ ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«æœ€çµ‚æ›´æ–°ã‚’å®Ÿè¡Œ
        window.addEventListener('beforeunload', function() {
            if (typeof window.updateCalendarAfterSave === 'function') {
                window.updateCalendarAfterSave();
            }
        });

        // ğŸš€ ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
        function updateDebug(message) {
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.textContent = `Debug: ${message}`;
            debugPanel.style.display = 'block';
        }

        // ğŸš€ ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½: æ‰‹å‹•ã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ã‚’ãƒ†ã‚¹ãƒˆ
        window.testCalendarUpdate = function() {
            console.log('ğŸ§ª Testing calendar update...');
            updateDebug('Testing update...');
            
            if (currentUser && currentUser.userId) {
                notifyCalendarUpdate(currentUser.userId)
                    .then(() => {
                        console.log('âœ… Calendar update test completed');
                        updateDebug('Test completed');
                        alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ãƒ†ã‚¹ãƒˆå®Œäº†ï¼');
                    })
                    .catch(error => {
                        console.error('âŒ Calendar update test failed:', error);
                        updateDebug('Test failed');
                        alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error.message);
                    });
            } else {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        };

        // ğŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        window.testTimezone = function() {
            console.log('ğŸ§ª Testing timezone functions...');
            
            const testDate = '2024-07-01';
            const parsed = TimezoneFixes.parseJapanDate(testDate);
            const formatted = TimezoneFixes.formatJapanDate(parsed);
            const today = TimezoneFixes.getTodayJapan();
            
            console.log('ğŸŒ Timezone Test Results:');
            console.log(`  Input: ${testDate}`);
            console.log(`  Parsed:`, parsed);
            console.log(`  Formatted: ${formatted}`);
            console.log(`  Today:`, today);
            console.log(`  Today formatted: ${TimezoneFixes.formatJapanDate(today)}`);
            
            TimezoneFixes.debugDateInfo(parsed, 'Parsed Date');
            TimezoneFixes.debugDateInfo(today, 'Today');
            
            updateTimezoneDebug('Timezone test', {
                testDate: testDate,
                parsed: parsed,
                formatted: formatted,
                today: today
            });
            
            alert(`ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆå®Œäº†ï¼\nå…¥åŠ›: ${testDate}\nå‡ºåŠ›: ${formatted}\nä»Šæ—¥: ${TimezoneFixes.formatJapanDate(today)}`);
        };

        // ğŸš€ é–‹ç™ºç”¨: ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        let debugMode = false;
        window.toggleDebug = function() {
            debugMode = !debugMode;
            const debugPanel = document.getElementById('debugPanel');
            const timezoneDebug = document.getElementById('timezoneDebug');
            
            debugPanel.style.display = debugMode ? 'block' : 'none';
            timezoneDebug.style.display = debugMode ? 'block' : 'none';
            
            console.log('Debug mode:', debugMode ? 'ON' : 'OFF');
        };

        // ğŸš€ é–‹ç™ºç”¨: ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        window.showDebugInfo = function() {
            console.log('=== DEBUG INFO ===');
            console.log('Current User:', currentUser);
            console.log('Selected Duration:', selectedDuration);
            console.log('LIFF in Client:', liff.isInClient());
            console.log('LIFF Logged In:', liff.isLoggedIn());
            console.log('Page URL:', window.location.href);
            console.log('Local Storage:', localStorage.getItem('calendar_update_event'));
            console.log('Timezone Offset:', new Date().getTimezoneOffset());
            console.log('Today (native):', new Date().toLocaleDateString('ja-JP'));
            console.log('Today (timezone-fixed):', TimezoneFixes.formatJapanDate(TimezoneFixes.getTodayJapan()));
            console.log('==================');
        };

        // ğŸš€ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®é–¢æ•°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        window.entryPageFunctions = {
            savePeriodStart: window.savePeriodStart,
            testCalendarUpdate: window.testCalendarUpdate,
            testTimezone: window.testTimezone,
            toggleDebug: window.toggleDebug,
            showDebugInfo: window.showDebugInfo,
            notifyCalendarUpdate: notifyCalendarUpdate,
            TimezoneFixes: TimezoneFixes,
            currentUser: () => currentUser,
            selectedDuration: () => selectedDuration
        };

        // ğŸš€ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒƒãƒ
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
            updateDebug(`Global Error: ${e.error?.message || 'Unknown error'}`);
            
            if (e.error?.message?.includes('LIFF')) {
                showError('LIFFé–¢é€£ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚LINEã‹ã‚‰æ­£ã—ãã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // ğŸš€ Promise rejection ã®ã‚­ãƒ£ãƒƒãƒ
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            updateDebug(`Promise Error: ${e.reason?.message || 'Unknown promise error'}`);
            
            if (e.reason?.message?.includes('fetch')) {
                showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // ğŸš€ ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
        window.addEventListener('pageshow', function(e) {
            if (e.persisted) {
                console.log('Page restored from cache');
                updateDebug('Page restored from cache');
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒã•ã‚ŒãŸå ´åˆã€ãƒ‡ãƒ¼ã‚¿ã‚’å†ç¢ºèª
                if (currentUser) {
                    updateDebug(`User restored: ${currentUser.displayName}`);
                }
            }
        });

        // ğŸš€ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ç›£è¦–
        window.addEventListener('online', function() {
            console.log('Network: Online');
            updateDebug('Network: Online');
        });

        window.addEventListener('offline', function() {
            console.log('Network: Offline');
            updateDebug('Network: Offline');
            showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        });

        // LIFFåˆæœŸåŒ–ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
        async function initializeLiffAndLoadUser() {
            try {
                console.log('Initializing LIFF...');
                updateDebug('Initializing LIFF...');
                
                await liff.init({ 
                    liffId: DATE_ENTRY_LIFF_ID,
                    withLoginOnExternalBrowser: true
                });
                
                console.log('LIFF initialized successfully');
                updateDebug('LIFF initialized');
                
                if (!liff.isLoggedIn()) {
                    console.log('User not logged in, redirecting...');
                    updateDebug('Login required');
                    liff.login();
                    return;
                }
                
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
                const profile = await liff.getProfile();
                console.log('User profile obtained:', profile.displayName);
                updateDebug(`User: ${profile.displayName}`);
                
                currentUser = profile;
                showUserInfo(profile);
                
            } catch (error) {
                console.error('LIFF initialization error:', error);
                updateDebug(`LIFF Error: ${error.message}`);
                showError('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚LINEã‹ã‚‰æ­£ã—ãã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Date entry page loaded');
            updateDebug('Page loaded');
            
            if (typeof liff !== 'undefined') {
                initializeLiffAndLoadUser();
            } else {
                updateDebug('LIFF SDK not loaded');
                showError('LIFF SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        });

        // ğŸš€ é–‹ç™ºç”¨: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®ç°¡å˜ã‚¢ã‚¯ã‚»ã‚¹
        console.log('ğŸš€ Entry Page Functions Available:');
        console.log('- window.testCalendarUpdate() - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ãƒ†ã‚¹ãƒˆ');
        console.log('- window.testTimezone() - ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†ãƒ†ã‚¹ãƒˆ');
        console.log('- window.toggleDebug() - ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ');
        console.log('- window.showDebugInfo() - ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º');
        console.log('- window.entryPageFunctions - å…¨æ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹');
        console.log('ğŸŒ Timezone fixes loaded and ready!');

    </script>
</body>
</html>log(`ğŸ› ${label}: null`);
                    return;
                }
                
                console.log(`ğŸ› ${label} Debug Info:`);
                console.log(`   - toString(): ${date.toString()}`);
                console.log(`   - toISOString(): ${date.toISOString()}`);
                console.log(`   - toLocaleDateString('ja-JP'): ${date.toLocaleDateString('ja-JP')}`);
                console.log(`   - getFullYear(): ${date.getFullYear()}`);
                console.log(`   - getMonth(): ${date.getMonth()}`);
                console.log(`   - getDate(): ${date.getDate()}`);
                console.log(`   - getTimezoneOffset(): ${date.getTimezoneOffset()}`);
            }
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let selectedDuration = 5; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5æ—¥
        const DATE_ENTRY_LIFF_ID = '2007500037-vdpkmNwL'; // é–‹å§‹æ—¥å…¥åŠ›å°‚ç”¨LIFF ID
        
        // ğŸŒ ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®šï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            const today = TimezoneFixes.getTodayJapan();
            const todayString = TimezoneFixes.formatJapanDate(today);
            document.getElementById('startDateInput').value = todayString;
            
            updateTimezoneDebug('Page loaded', {
                today: today,
                todayString: todayString
            });
        });
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = message;
            errorDiv.style.display = 'block';
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤º
        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
        function showUserInfo(profile) {
            const userInfoDiv = document.getElementById('userInfo');
            userInfoDiv.innerHTML = `
                ğŸ‘¤ ${profile.displayName} ã•ã‚“
            `;
            userInfoDiv.style.display = 'block';
        }

        // ğŸŒ ã‚¯ã‚¤ãƒƒã‚¯æ—¥ä»˜è¨­å®šï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œï¼‰
        function setQuickDate(daysAgo) {
            const today = TimezoneFixes.getTodayJapan();
            const targetDate = TimezoneFixes.addDaysJapan(today, -daysAgo);
            const dateString = TimezoneFixes.formatJapanDate(targetDate);
            
            document.getElementById('startDateInput').value = dateString;
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®æ›´æ–°
            document.querySelectorAll('.quick-date-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateTimezoneDebug('Quick date set', {
                daysAgo: daysAgo,
                today: today,
                targetDate: targetDate,
                dateString: dateString
            });
        }

        // æœŸé–“è¨­å®š
        function setDuration(days) {
            selectedDuration = days;
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®æ›´æ–°
            document.querySelectorAll('.duration-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // ğŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
        function updateTimezoneDebug(action, data) {
            const debugDiv = document.getElementById('timezoneDebug');
            
            let debugInfo = `ğŸŒ ${action}:\n`;
            
            for (const [key, value] of Object.entries(data)) {
                if (value instanceof Date) {
                    debugInfo += `  ${key}: ${value.toLocaleDateString('ja-JP')} (${TimezoneFixes.formatJapanDate(value)})\n`;
                } else {
                    debugInfo += `  ${key}: ${value}\n`;
                }
            }
            
            debugDiv.innerHTML = debugInfo.replace(/\n/g, '<br>');
            debugDiv.style.display = 'block';
            
            console.log(debugInfo);
        }

        // ğŸš€ ç”Ÿç†é–‹å§‹æ—¥ä¿å­˜ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œç‰ˆï¼‰
        window.savePeriodStart = async function() {
            console.log('=== savePeriodStart called (TIMEZONE FIXED VERSION) ===');
            
            hideError();
            
            const startDateString = document.getElementById('startDateInput').value;
            
            if (!startDateString) {
                showError('é–‹å§‹æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // ğŸŒ æ—¥ä»˜ã‚’ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œã§è§£æ
            const selectedDate = TimezoneFixes.parseJapanDate(startDateString);
            const today = TimezoneFixes.getTodayJapan();
            
            updateTimezoneDebug('Date validation', {
                startDateString: startDateString,
                selectedDate: selectedDate,
                today: today
            });
            
            // æœªæ¥ã®æ—¥ä»˜ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œï¼‰
            if (TimezoneFixes.compareDatesJapan(selectedDate, today) > 0) {
                showError('æœªæ¥ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“');
                return;
            }
            
            // 3ãƒ¶æœˆä»¥ä¸Šå‰ã®ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œï¼‰
            const threeMonthsAgo = new Date(today);
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            
            if (TimezoneFixes.compareDatesJapan(selectedDate, threeMonthsAgo) < 0) {
                showError('3ãƒ¶æœˆä»¥ä¸Šå‰ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“');
                return;
            }

            if (!currentUser) {
                showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('entryForm').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';

            try {
                // ğŸŒ çµ‚äº†æ—¥è¨ˆç®—ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œï¼‰
                const endDate = TimezoneFixes.addDaysJapan(selectedDate, selectedDuration - 1);
                const endDateString = TimezoneFixes.formatJapanDate(endDate);
                
                const requestData = {
                    userId: currentUser.userId,
                    startDate: startDateString, // YYYY-MM-DD å½¢å¼ã§é€ä¿¡
                    endDate: endDateString,     // YYYY-MM-DD å½¢å¼ã§é€ä¿¡
                    duration: selectedDuration
                };
                
                updateTimezoneDebug('Request preparation', {
                    selectedDate: selectedDate,
                    endDate: endDate,
                    startDateString: startDateString,
                    endDateString: endDateString
                });
                
                console.log('ğŸš€ Request data:', JSON.stringify(requestData, null, 2));
                updateDebug('Sending request...');
                
                // è¨˜éŒ²ä¿å­˜APIå‘¼ã³å‡ºã—
                const response = await fetch('https://asia-northeast1-menstrual-tracking-app.cloudfunctions.net/savePeriodRecord', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('ğŸ“¡ Response status:', response.status);
                updateDebug(`Response: ${response.status}`);

                if (response.ok) {
                    const responseData = await response.json();
                    console.log('âœ… Response data:', JSON.stringify(responseData, null, 2));

                    // ğŸš€ ä¿å­˜æˆåŠŸå¾Œã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ã‚’ãƒˆãƒªã‚¬ãƒ¼
                    console.log('ğŸ”„ Triggering calendar updates...');
                    updateDebug('Updating calendars...');
                    
                    try {
                        // ğŸŒ å…¨ã¦ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«æ›´æ–°ã‚’é€šçŸ¥
                        await notifyCalendarUpdate(currentUser.userId);
                        console.log('âœ… Calendar update notification sent');
                        updateDebug('Calendar update sent');
                    } catch (updateError) {
                        console.error('âŒ Calendar update notification failed:', updateError);
                        updateDebug('Update notification failed');
                        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼ã¯æˆåŠŸè¡¨ç¤ºã«ã¯å½±éŸ¿ã—ãªã„
                    }

                    // ğŸš€ æˆåŠŸè¡¨ç¤ºã‚’æ”¹å–„
                    showSuccessWithCalendarUpdate();

                    // ğŸš€ 3ç§’å¾Œã«LINEã‚¢ãƒ—ãƒªã«æˆ»ã‚‹ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°æ™‚é–“ã‚’ç¢ºä¿ï¼‰
                    setTimeout(() => {
                        updateDebug('Closing window...');
                        if (liff.isInClient()) {
                            liff.closeWindow();
                        } else {
                            // ğŸš€ ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                            const calendarUrl = `/calendar/?userId=${encodeURIComponent(currentUser.userId)}&updated=${Date.now()}`;
                            window.location.href = calendarUrl;
                        }
                    }, 3000);

                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`);
                }

            } catch (error) {
                console.error('âŒ Error saving period record:', error);
                updateDebug(`Error: ${error.message}`);
                
                showError(`è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã‚‹
                document.getElementById('loading').style.display = 'none';
                document.getElementById('entryForm').style.display = 'block';
            }
        };

        // ğŸš€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°é€šçŸ¥
        async function notifyCalendarUpdate(userId) {
            console.log('ğŸ”„ Starting calendar update notification process...');
            
            try {
                // ğŸŒ æ–¹æ³•1: localStorage ã‚’ä½¿ç”¨ã—ã¦ä»–ã®ã‚¿ãƒ–ã«é€šçŸ¥
                if (typeof Storage !== 'undefined') {
                    const updateEvent = {
                        type: 'period_record_saved',
                        userId: userId,
                        timestamp: Date.now(),
                        source: 'date_entry'
                    };
                    
                    localStorage.setItem('calendar_update_event', JSON.stringify(updateEvent));
                    console.log('ğŸ“¢ LocalStorage update event set');
                    
                    // å³åº§ã«å‰Šé™¤ã—ã¦ä¸€æ„æ€§ã‚’ä¿ã¤
                    setTimeout(() => {
                        localStorage.removeItem('calendar_update_event');
                    }, 1000);
                }
                
                // ğŸŒ æ–¹æ³•2: PostMessage ã‚’ä½¿ç”¨ã—ã¦ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–“é€šä¿¡
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'period_record_saved',
                        userId: userId,
                        timestamp: Date.now(),
                        source: 'date_entry'
                    }, '*');
                    console.log('ğŸ“¢ PostMessage sent to opener window');
                }
                
                // ğŸŒ æ–¹æ³•3: å¼·åˆ¶çš„ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                const calendarUpdateUrl = `https://asia-northeast1-menstrual-tracking-app.cloudfunctions.net/getCalendarData?userId=${encodeURIComponent(userId)}&forceUpdate=true&timestamp=${Date.now()}`;
                
                const updateResponse = await fetch(calendarUpdateUrl, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (updateResponse.ok) {
                    console.log('âœ… Calendar data force updated');
                } else {
                    console.warn('âš ï¸ Calendar data force update failed');
                }
                
                // ğŸŒ æ–¹æ³•4: ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã‚’äº‹å‰ã«æº–å‚™
                if (!liff.isInClient()) {
                    const calendarUrl = `/calendar/?userId=${encodeURIComponent(userId)}&updated=${Date.now()}`;
                    
                    // ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
                    const prefetchLink = document.createElement('link');
                    prefetchLink.rel = 'prefetch';
                    prefetchLink.href = calendarUrl;
                    document.head.appendChild(prefetchLink);
                    
                    console.
